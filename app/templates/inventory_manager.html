{% extends "base.html" %}

{% block header %}
Master Inventory
{% endblock %}

{% macro render_inventory_table(title, items, type_key) %}
<div class="inventory-section bg-white p-6 sm:p-8 shadow-xl rounded-2xl border border-gray-200" data-type-key="{{ type_key }}">
    <form action="{{ url_for('main_bp.inventory_manager') }}" method="POST">
        <input type="hidden" name="item_type" value="{{ type_key }}">
        
        <!-- Section Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b border-gray-200 pb-5 mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">{{ title }}</h2>
                <p class="text-sm text-gray-500 mt-1">Base rates for all {{ title | lower }}.</p>
            </div>
            <div class="flex items-center gap-x-3">
                <button type="button" class="view-mode-el btn-secondary !px-4 !py-2" onclick="toggleEditMode('{{ type_key }}', true)">Edit {{ title }}</button>
                <button type="button" class="edit-mode-el hidden btn-secondary !py-2" onclick="toggleEditMode('{{ type_key }}', false)">Cancel</button>
                <button type="submit" class="edit-mode-el hidden btn-primary !py-2">Save Changes</button>
            </div>
        </div>

        <!-- Items Table -->
        <div class="flow-root">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0 w-2/5">Type</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 w-1/5">Unit</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 w-1/5">Price</th>
                        <th class="relative py-3.5 pl-3 pr-4 sm:pr-0 w-1/5"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white" id="tbody-{{ type_key }}">
                    {% for item in items %}
                    <tr class="item-row" id="row-{{ item.id }}">
                        <input type="hidden" class="action-input" name="items[{{ item.id }}][action]" value="update" disabled>
                        <td class="py-4 pl-4 pr-3 sm:pl-0">
                            <span class="view-mode-el font-medium text-gray-900">{{ item.name }}</span>
                            <div class="edit-mode-el hidden"><input type="text" name="items[{{ item.id }}][name]" value="{{ item.name }}" class="form-input !py-1.5" required></div>
                        </td>
                        <td class="px-3 py-4">
                            <span class="view-mode-el text-gray-500">{{ item.unit }}</span>
                            <div class="edit-mode-el hidden"><input type="text" name="items[{{ item.id }}][unit]" value="{{ item.unit }}" class="form-input !py-1.5" required></div>
                        </td>
                        <td class="px-3 py-4">
                            <span class="view-mode-el text-gray-500">Rs. {{ "%.2f"|format(item.price) }}</span>
                            <div class="edit-mode-el hidden"><input type="number" step="0.01" name="items[{{ item.id }}][price]" value="{{ item.price }}" class="form-input !py-1.5" required></div>
                        </td>
                        <td class="py-4 pl-3 pr-4 text-right sm:pr-0">
                            <button type="button" onclick="deleteRow('{{ item.id }}')" class="edit-mode-el hidden text-red-500 hover:text-red-700 font-semibold">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Add New Item Button (in edit mode) -->
        <div class="edit-mode-el hidden mt-6 border-t pt-6">
            <button type="button" onclick="addNewRow('{{ type_key }}')" class="btn-secondary w-full sm:w-auto">
                + Add New Item
            </button>
        </div>
    </form>
</div>
{% endmacro %}

{% block content %}
<div class="space-y-12">
    {{ render_inventory_table('Labor', labor, 'labor') }}
    {{ render_inventory_table('Materials', material, 'material') }}
    {{ render_inventory_table('Equipment', equipment, 'equipment') }}
</div>

<!-- CLIENT-SIDE INTERACTIVITY ENGINE -->
<script>
    function toggleEditMode(typeKey, isEditing) {
        const section = document.querySelector(`.inventory-section[data-type-key="${typeKey}"]`);
        
        section.querySelectorAll('.view-mode-el').forEach(el => el.classList.toggle('hidden', isEditing));
        section.querySelectorAll('.edit-mode-el').forEach(el => el.classList.toggle('hidden', !isEditing));
        section.querySelectorAll('.item-row input, .item-row select').forEach(input => input.disabled = !isEditing);
    }

    function addNewRow(typeKey) {
        const tbody = document.getElementById(`tbody-${typeKey}`);
        const newId = `new-${Date.now()}`;
        const newRow = document.createElement('tr');
        newRow.className = 'item-row';
        newRow.id = `row-${newId}`;
        newRow.innerHTML = `
            <input type="hidden" class="action-input" name="items[${newId}][action]" value="create">
            <td class="py-4 pl-4 pr-3 sm:pl-0">
                <input type="text" name="items[${newId}][name]" class="form-input !py-1.5" placeholder="New Item Name" required>
            </td>
            <td class="px-3 py-4">
                <input type="text" name="items[${newId}][unit]" class="form-input !py-1.5" placeholder="Unit" required>
            </td>
            <td class="px-3 py-4">
                <input type="number" step="0.01" name="items[${newId}][price]" class="form-input !py-1.5" placeholder="0.00" required>
            </td>
            <td class="py-4 pl-3 pr-4 text-right sm:pr-0">
                <button type="button" onclick="this.closest('tr').remove()" class="text-gray-500 hover:text-red-700 font-semibold">Remove</button>
            </td>
        `;
        tbody.appendChild(newRow);
    }

    function deleteRow(itemId) {
        const row = document.getElementById(`row-${itemId}`);
        const actionInput = row.querySelector('.action-input');
        if (confirm('Are you sure you want to delete this item? This will be saved permanently.')) {
            row.style.display = 'none'; // Visually hide it
            actionInput.value = 'delete'; // Mark for deletion on submit
        }
    }
</script>
{% endblock %}
