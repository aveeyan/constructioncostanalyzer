{% extends "base.html" %}

{% block content %}
<div class="space-y-16">
    <!-- Section to Display Existing Work Item Cards -->
    <div>
        <h2 class="text-2xl font-bold leading-7 text-gray-900 tracking-tight">Defined Work Items (Cards)</h2>
        <div class="mt-6 grid grid-cols-1 xl:grid-cols-2 gap-12 items-start">
            {% for item in category.work_items %}
            <div class="bg-white shadow-xl rounded-2xl border border-gray-200 overflow-hidden transition-all duration-300 hover:shadow-2xl hover:border-indigo-300">
                <div class="px-6 py-5 bg-gray-50/70 border-b flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">{{ item.name }}</h3>
                        <p class="text-sm text-gray-500">Analysis for <span class="font-bold text-gray-700">{{ item.basis_quantity|default(1) }} {{ item.unit_of_measure }}(s)</span></p>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                        <a href="{{ url_for('main_bp.category_detail', category_id=category.id, edit_item_id=item.id) }}#work-item-form-anchor" class="btn-secondary !px-3 !py-1.5 !text-xs">Edit</a>
                        <form action="{{ url_for('main_bp.delete_work_item', category_id=category.id, work_item_id=item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this item?');"><button type="submit" class="btn-delete !px-3 !py-1.5 !text-xs">Delete</button></form>
                    </div>
                </div>
                
                <!-- ================================================================== -->
                <!-- THE CORRECTED AND RESTYLED TABLE STRUCTURE -->
                <!-- ================================================================== -->
                <table class="min-w-full">
                    <thead class="border-b border-gray-200">
                        <tr class="text-xs font-semibold text-gray-500 uppercase">
                            <th class="px-6 py-3 text-left">Resource</th>
                            <th class="px-6 py-3 text-left">Type</th>
                            <th class="px-6 py-3 text-right">Qty</th>
                            <th class="px-6 py-3 text-right">Rate</th>
                            <th class="px-6 py-3 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        {# THIS MACRO HAS BEEN RE-ENGINEERED TO FIX THE ROWSPAN BUG #}
                        {% macro render_rows(resource_name, components, item) %}
                            {% if components %}
                                {# Render the first component row with rowspan #}
                                {% set first_comp = components[0] %}
                                <tr class="border-b border-gray-100">
                                    <td class="px-6 py-3 align-top font-medium text-gray-600" rowspan="{{ components|length }}">{{ resource_name }}</td>
                                    <td class="px-6 py-3 text-gray-800">{{ first_comp.name }}</td>
                                    <td class="px-6 py-3 text-gray-600 text-right">{{ '%.2f'|format(first_comp.quantity) }}</td>
                                    <td class="px-6 py-3 text-gray-600 text-right">{{ '%.2f'|format(first_comp.unit_price) }}</td>
                                    <td class="px-6 py-3 text-gray-900 font-semibold text-right">{{ '%.2f'|format(first_comp.subtotal) }}</td>
                                </tr>
                                {# Render subsequent component rows without the first cell #}
                                {% for comp in components[1:] %}
                                <tr class="border-b border-gray-100">
                                    <td class="px-6 py-3 text-gray-800">{{ comp.name }}</td>
                                    <td class="px-6 py-3 text-gray-600 text-right">{{ '%.2f'|format(comp.quantity) }}</td>
                                    <td class="px-6 py-3 text-gray-600 text-right">{{ '%.2f'|format(comp.unit_price) }}</td>
                                    <td class="px-6 py-3 text-gray-900 font-semibold text-right">{{ '%.2f'|format(comp.subtotal) }}</td>
                                </tr>
                                {% endfor %}
                                {# Render the total row for this resource #}
                                <tr class="bg-gray-100/80">
                                    <td colspan="4" class="px-6 py-2 text-right font-bold text-gray-800">Total for {{ resource_name }}</td>
                                    <td class="px-6 py-2 font-extrabold text-gray-900 text-right">{{ "%.2f"|format(item[resource_name.lower() ~ '_total']) }}</td>
                                </tr>
                            {% endif %}
                        {% endmacro %}

                        {{ render_rows('Labor', item.labor, item) }}
                        {{ render_rows('Material', item.material, item) }}
                        {{ render_rows('Equipment', item.equipment, item) }}
                    </tbody>
                </table>
                <div class="p-6 bg-gray-50/70 grid grid-cols-2 items-end">
                    <!-- "SEXY" PRICE TAG -->
                    <div>
                        <div class="inline-block rounded-lg overflow-hidden border-2 border-orange-500 shadow-lg">
                            <div class="bg-orange-500 text-white text-sm font-bold px-4 py-1 text-center">
                                Price Per 1 {{ item.unit_of_measure }}
                            </div>
                            <div class="bg-white text-orange-600 font-extrabold text-3xl px-4 py-2 text-center">
                                Rs. {{ "%.2f"|format(item.price_per_unit|default(0)) }}
                            </div>
                        </div>
                    </div>
                    <!-- FINAL TOTALS -->
                    <div class="text-right space-y-1 text-sm">
                        <div><span class="text-gray-600">Total Cost:</span> <span class="font-semibold text-gray-800 w-24 inline-block text-right">Rs. {{ "%.2f"|format(item.total_cost_per_unit|default(0)) }}</span></div>
                        <div><span class="text-gray-600">Total Overhead:</span> <span class="font-semibold text-gray-800 w-24 inline-block text-right">Rs. {{ "%.2f"|format(item.contractor_overhead_15_percent|default(0)) }}</span></div>
                        <div class="text-base mt-2 pt-2 border-t border-gray-300"><span class="font-bold text-gray-800">Grand Total:</span> <span class="font-extrabold text-gray-900 w-24 inline-block text-right">Rs. {{ "%.2f"|format(item.sum_total|default(0)) }}</span></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="xl:col-span-2 py-16 text-center text-gray-500 bg-white shadow-md rounded-2xl border-2 border-dashed">
                <h3 class="text-lg font-medium">No Work Items Defined</h3><p class="mt-1">Use the form below to create the first work item for this category.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ADD/EDIT FORM (No functional changes, only minor style consistency) -->
    <div class="pt-10" id="work-item-form-anchor">
        <form id="work-item-form" method="POST" action="{{ url_for('main_bp.category_detail', category_id=category.id, edit_item_id=editing_item.id if editing_item else None) }}">
            <div class="bg-white p-8 shadow-2xl rounded-2xl border border-gray-200">
                <h2 class="text-2xl font-bold tracking-tight text-gray-900">{{ "Edit Work Item" if editing_item else "Add New Work Item" }}</h2>
                <p class="mt-1 text-sm leading-6 text-gray-600">{% if editing_item %}Update the components for '{{ editing_item.name }}'.{% else %}Combine components to define a cost unit for '{{ category.name }}'.{% endif %}</p>
                <div class="mt-8 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6 border-t border-gray-200 pt-8">
                    <div class="sm:col-span-3"><label for="name" class="block text-sm font-medium leading-6 text-gray-900">Work Item Name</label><input type="text" name="name" id="name" value="{{ form_state.name }}" class="form-input" placeholder="e.g., Excavation in Soft Soil" required></div>
                    <div class="sm:col-span-1"><label for="basis_quantity" class="block text-sm font-medium leading-6 text-gray-900">For Qty</label><input type="number" name="basis_quantity" id="basis_quantity" value="{{ form_state.basis_quantity|default(1.0) }}" step="0.01" class="form-input" required></div>
                    <div class="sm:col-span-2"><label for="unit_of_measure" class="block text-sm font-medium leading-6 text-gray-900">Unit of Measure</label><input type="text" name="unit_of_measure" id="unit_of_measure" value="{{ form_state.unit_of_measure or 'Cubic Meter' }}" class="form-input" required></div>
                </div>
                <div class="mt-10 space-y-10" id="components-container">
                    {% macro render_component_form(title, item_type, form_items, master_items) %}
                    <div class="component-section" data-type="{{ item_type }}"><div class="flex justify-between items-center pb-4 border-b"><h3 class="text-lg font-medium text-gray-900">{{ title }}</h3><button type="submit" name="action" value="add_{{ item_type }}" class="btn-secondary !px-3 !py-1.5 !text-sm !font-semibold">+ Add</button></div>
                        <div class="mt-4 space-y-4">
                            {% for item in form_items %}
                            <div class="grid grid-cols-12 gap-x-4 gap-y-2 items-center component-row">
                                <div class="col-span-12 sm:col-span-7"><select name="{{ item_type }}-{{ loop.index0 }}-id" class="form-select component-id"><option value="">Select...</option>{% for master_item in master_items %}<option value="{{ master_item.SerialNo }}" data-price="{{ master_item.Price }}" {% if item.id|string == master_item.SerialNo|string %}selected{% endif %}>{{ master_item.Type }} (Rs. {{ master_item.Price }}/{{ master_item.Unit }})</option>{% endfor %}</select></div>
                                <div class="col-span-6 sm:col-span-3"><input type="number" name="{{ item_type }}-{{ loop.index0 }}-quantity" value="{{ item.quantity or '1.0' }}" step="0.01" class="form-input component-quantity" placeholder="Quantity"></div>
                                <div class="col-span-6 sm:col-span-2 text-right font-medium text-gray-700 component-subtotal">Rs. 0.00</div>
                            </div>
                            {% else %}<div class="text-center py-6 px-3 border-2 border-dashed rounded-lg text-sm text-gray-500 bg-slate-50/50">No {{ item_type }} components added.</div>{% endfor %}
                        </div>
                        <div class="mt-4 text-right font-bold pr-2 text-gray-800">Total: <span class="section-total">Rs. 0.00</span></div>
                    </div>
                    {% endmacro %}
                    {{ render_component_form('Labor Components', 'labor', form_state.labor, master_labor) }}
                    {{ render_component_form('Material Components', 'material', form_state.material, master_material) }}
                    {{ render_component_form('Equipment Components', 'equipment', form_state.equipment, master_equipment) }}
                </div>
                <div class="mt-12 pt-8 border-t-2 border-gray-200"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center"><div id="live-per-unit-price-container" class="text-center md:text-left p-6 bg-indigo-50 rounded-xl"><span class="text-md font-semibold text-indigo-800">Live Price Per 1 Unit</span><p id="live-per-unit-price" class="text-4xl font-extrabold text-indigo-600">Rs. 0.00</p></div><div class="space-y-3 p-4"><div class="flex justify-between text-md"><span class="text-gray-600">Actual Rate</span><span id="live-actual-rate" class="font-semibold text-gray-800">Rs. 0.00</span></div><div class="flex justify-between text-md"><span class="text-gray-600">15% Contractor Overhead</span><span id="live-overhead" class="font-semibold text-gray-800">Rs. 0.00</span></div><div class="flex justify-between text-xl items-center mt-2 pt-2 border-t"><span class="font-bold text-gray-800">Grand Total</span><span id="live-grand-total" class="font-extrabold text-2xl text-gray-900">Rs. 0.00</span></div></div></div></div>
            </div>
            <div class="mt-8 flex justify-end items-center">
                {% if editing_item %}<a href="{{ url_for('main_bp.category_detail', category_id=category.id) }}" class="btn-secondary mr-4">Cancel Edit</a><button type="submit" formaction="{{ url_for('main_bp.update_work_item', category_id=category.id, work_item_id=editing_item.id) }}" class="btn-primary !px-8 !py-3 !text-base">Update Work Item</button>
                {% else %}<button type="submit" formaction="{{ url_for('main_bp.save_work_item', category_id=category.id) }}" class="btn-primary !px-8 !py-3 !text-base">Save New Work Item</button>{% endif %}
            </div>
        </form>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('work-item-form');
    function formatCurrency(value) { return 'Rs. ' + (value || 0).toFixed(2); }
    function calculateCosts() {
        let totalActualRate = 0;
        document.querySelectorAll('.component-section').forEach(section => {
            let sectionTotal = 0;
            section.querySelectorAll('.component-row').forEach(row => {
                const select = row.querySelector('.component-id'), quantityInput = row.querySelector('.component-quantity'), subtotalEl = row.querySelector('.component-subtotal');
                const price = parseFloat(select.options[select.selectedIndex]?.dataset.price) || 0, quantity = parseFloat(quantityInput.value) || 0;
                const subtotal = price * quantity;
                subtotalEl.textContent = formatCurrency(subtotal);
                sectionTotal += subtotal;
            });
            section.querySelector('.section-total').textContent = formatCurrency(sectionTotal);
            totalActualRate += sectionTotal;
        });
        const overhead = totalActualRate * 0.15, grandTotal = totalActualRate + overhead;
        let basisQty = parseFloat(document.getElementById('basis_quantity').value) || 1.0;
        if (basisQty <= 0) basisQty = 1.0;
        const perUnitPrice = grandTotal / basisQty;
        document.getElementById('live-actual-rate').textContent = formatCurrency(totalActualRate);
        document.getElementById('live-overhead').textContent = formatCurrency(overhead);
        document.getElementById('live-grand-total').textContent = formatCurrency(grandTotal);
        document.getElementById('live-per-unit-price').textContent = formatCurrency(perUnitPrice);
    }
    container.addEventListener('input', e => { if (e.target.matches('.component-id, .component-quantity, #basis_quantity')) calculateCosts(); });
    calculateCosts();
});
</script>
{% endblock %}
